openapi: 3.1.0
info:
  title: Auth Service API
  description: |
    Servicio de autenticaci√≥n y autorizaci√≥n con soporte para:
    - Registro y login de usuarios
    - Gesti√≥n de sesiones con JWT (RS256)
    - Sistema RBAC (Role-Based Access Control)
    - Control de acceso granular con permisos
    - Multi-tenancy completo (Apps + Tenants)
    - Token blacklist con invalidaci√≥n por timestamp
    - Reset de contrase√±a seguro con email
    - Sistema de invitaciones por token

    ## Sistema Multi-Tenant

    El servicio implementa multi-tenancy en dos niveles:

    ### 1. Apps (Aplicaciones)
    Nivel superior de aislamiento. Cada aplicaci√≥n tiene:
    - Sus propios roles y permisos
    - Sus propios tenants
    - Aislamiento completo de datos

    ### 2. Tenants (Workspaces/Organizaciones)
    Nivel secundario dentro de una app. Cada tenant tiene:
    - Sus propios usuarios (aislamiento por `app_id + tenant_id + email`)
    - Control de cuotas (m√°ximo de usuarios)
    - Sistema de invitaciones por token
    - 3 tipos: `public` (default), `workspace`, `enterprise`

    **Constraint de unicidad:** `UNIQUE(app_id, tenant_id, email)`

    ## Sistema RBAC (Roles & Permisos)

    El sistema implementa control de acceso basado en roles con permisos granulares.

    ### Roles por Defecto
    Cada app tiene 4 roles creados autom√°ticamente:
    - `user`: Permisos b√°sicos (read:own)
    - `moderator`: Permisos de moderaci√≥n
    - `admin`: Permisos administrativos completos
    - `super_admin`: Acceso total al sistema

    ### Permisos Granulares
    22 permisos implementados sobre recursos:
    - `users`: read:own, update:own, read:all, update:all, delete:all
    - `roles`: read, create, update, delete, assign
    - `sessions`: read:own, manage:own, read:all, manage:all
    - `apps`: read, create, update, delete
    - `tenants`: read, create, update, delete, manage

    ### Uso de Permisos vs Roles

    **Actualmente en rutas:** Se usa verificaci√≥n de roles
    ```go
    admin.Get("/users", userHandler.ListUsers) // Requiere rol admin
    ```

    **Disponible con permisos:** M√°s granular y flexible
    ```go
    admin.Get("/users",
        middleware.RequirePermission(roleService, "users", "read:all"),
        userHandler.ListUsers,
    )
    ```

    Los permisos se agregan autom√°ticamente a trav√©s de:
    - **Repository:** `HasPermission(userID, resource, action)`
    - **Service:** `roleService.HasPermission(ctx, userID, "users", "read:all")`
    - **Middleware:** `RequirePermission(roleService, "users", "read:all")`

    **Query de verificaci√≥n:**
    ```sql
    SELECT COUNT(*) FROM permissions p
    INNER JOIN role_permissions rp ON p.id = rp.permission_id
    INNER JOIN roles r ON rp.role_id = r.id
    INNER JOIN user_roles ur ON r.id = ur.role_id
    WHERE ur.user_id = $1 AND p.resource = $2 AND p.action = $3
    ```

    ## Sistema de Token Blacklist
    
    El servicio implementa un sistema de blacklist de dos niveles:
    
    ### 1. Blacklist Individual de Tokens
    Tokens espec√≠ficos pueden ser agregados a la blacklist (ej: al hacer logout).
    
    ### 2. Blacklist de Usuario por Timestamp
    Al cambiar/resetear contrase√±a, se guarda un timestamp de invalidaci√≥n.
    Todos los tokens emitidos ANTES de ese timestamp son rechazados.
    Tokens emitidos DESPU√âS del timestamp son aceptados.
    
    **Ejemplo:**
    ```
    10:00 - Login ‚Üí Token A (IssuedAt: 10:00)
    10:30 - Reset password ‚Üí Invalidation timestamp: 10:30
    10:31 - Token A rechazado (10:00 < 10:30)
    10:32 - Nuevo login ‚Üí Token B (IssuedAt: 10:32)
    10:33 - Token B aceptado (10:32 >= 10:30)
    ```
    
    Esto permite:
    - ‚úÖ Invalidar todos los tokens antiguos
    - ‚úÖ Permitir nuevos logins inmediatamente
    - ‚úÖ Evitar bloqueos permanentes del usuario
  version: 1.5.0
  contact:
    name: API Support
    email: support@authservice.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  x-changelog:
    - version: 1.5.0
      date: 2024-12-14
      changes:
        - "‚úÖ Implementado Multi-Tenancy completo con Tenants e Invitaciones"
        - "‚úÖ POST /api/v1/admin/tenants - Crear tenant (workspace/organization)"
        - "‚úÖ GET /api/v1/admin/tenants - Listar tenants con paginaci√≥n"
        - "‚úÖ PUT /api/v1/admin/tenants/:id - Actualizar tenant"
        - "‚úÖ POST /api/v1/admin/tenants/:id/invitations - Crear invitaci√≥n con token"
        - "‚úÖ GET /api/v1/admin/tenants/:id/invitations - Listar invitaciones"
        - "‚úÖ DELETE /api/v1/admin/tenants/:id/invitations/:invId - Revocar invitaci√≥n"
        - "‚úÖ GET /api/v1/auth/validate-invitation/:token - Validar token (p√∫blico)"
        - "‚úÖ Agregados schemas: Tenant, TenantInvitation"
        - "üîí Aislamiento de usuarios por tenant (app_id + tenant_id + email)"
    - version: 1.4.0
      date: 2024-12-07
      changes:
        - "‚úÖ Implementado Session Management completo"
        - "‚úÖ GET /api/v1/users/me/sessions - Listar sesiones activas"
        - "‚úÖ DELETE /api/v1/users/me/sessions/:id - Cerrar sesi√≥n espec√≠fica"
        - "‚úÖ DELETE /api/v1/users/me/sessions - Cerrar todas las sesiones"
        - "‚úÖ Agregado schema Session con metadata (IP, User-Agent)"
        - "‚úÖ Handler completo con validaci√≥n de ownership"
        - "üîí Mejora de seguridad: usuarios pueden auditar y cerrar sesiones remotamente"
    - version: 1.3.0
      date: 2024-12-07
      changes:
        - "‚úÖ Documentados endpoints JWKS (/.well-known/jwks.json)"
        - "‚úÖ Documentado endpoint de setup de super admin"
        - "‚úÖ Documentados 3 endpoints de App Management (super-admin)"
        - "‚úÖ Agregados schemas: JWKS, JWK, App"
        - "‚úÖ Agregados tags: JWKS, Setup, Apps"
        - "üìù Documentaci√≥n completa de funcionalidades implementadas"
    - version: 1.2.0
      date: 2024-12-01
      changes:
        - "‚úÖ Agregados endpoints de listado de usuarios (admin)"
        - "‚úÖ GET /api/v1/admin/users - Lista usuarios con paginaci√≥n y b√∫squeda"
        - "‚úÖ GET /api/v1/admin/users/:id - Obtener usuario espec√≠fico"
        - "‚úÖ Respuestas incluyen roles asignados a cada usuario"
        - "üìù Documentaci√≥n consolidada en 3 archivos principales"
    - version: 1.1.0
      date: 2024-11-30
      changes:
        - "‚úÖ Agregados endpoints de forgot-password y reset-password"
        - "‚úÖ Agregados endpoints de verificaci√≥n de email"
        - "‚úÖ Agregado endpoint de cambio de contrase√±a"
        - "üîß Corregido bug cr√≠tico en token blacklist"
        - "üîí Mejorada seguridad del reset de contrase√±a"
        - "üìù Documentaci√≥n completa del sistema de blacklist"
    - version: 1.0.0
      date: 2024-11-15
      changes:
        - "üéâ Release inicial"
        - "‚úÖ Sistema de autenticaci√≥n con JWT"
        - "‚úÖ Sistema RBAC completo"
        - "‚úÖ Gesti√≥n de sesiones"
        - "‚úÖ Account locking"
        - "‚úÖ Multi-tenancy con App ID"

servers:
  - url: http://localhost:8080
    description: Desarrollo local
  - url: https://auth.cloudcentinel.com
    description: Producci√≥n

tags:
  - name: Health
    description: Endpoints de health check
  - name: JWKS
    description: JSON Web Key Set para validaci√≥n de tokens
  - name: Setup
    description: Configuraci√≥n inicial del sistema
  - name: Authentication
    description: Registro, login, refresh y logout
  - name: Users
    description: Gesti√≥n de perfil de usuario
  - name: Roles
    description: Gesti√≥n de roles (Admin)
  - name: Permissions
    description: Consulta de permisos
  - name: Apps
    description: Gesti√≥n de aplicaciones (Super Admin)
  - name: Tenants
    description: Gesti√≥n de tenants/workspaces (Admin)

security:
  - BearerAuth: []

paths:
  # ===== HEALTH CHECKS =====
  /health:
    get:
      tags:
        - Health
      summary: Health check b√°sico
      description: Verifica que el servicio est√° corriendo
      security: []
      responses:
        '200':
          description: Servicio saludable
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time

  /ready:
    get:
      tags:
        - Health
      summary: Readiness check
      description: Verifica que el servicio est√° listo para recibir tr√°fico
      security: []
      responses:
        '200':
          description: Servicio listo
          content:
            application/json:
              schema:
                type: object
                properties:
                  ready:
                    type: boolean
                  database:
                    type: string
                    example: connected
                  redis:
                    type: string
                    example: connected

  # ===== JWKS =====
  /.well-known/jwks.json:
    get:
      tags:
        - JWKS
      summary: JSON Web Key Set
      description: |
        Retorna el conjunto de claves p√∫blicas en formato JWK (JSON Web Key).
        Este endpoint es utilizado por otros servicios para validar la firma
        de los JWT tokens emitidos por este servicio de autenticaci√≥n.

        **Uso:**
        - Validaci√≥n de tokens JWT en microservicios
        - Integraci√≥n con API Gateways
        - Verificaci√≥n de firma RS256

        **Formato JWK:**
        - `kty`: Key Type (RSA)
        - `use`: Public Key Use (sig = signature)
        - `kid`: Key ID (identificador √∫nico de la clave)
        - `alg`: Algorithm (RS256)
        - `n`: Modulus (en base64url)
        - `e`: Exponent (en base64url)
      security: []
      responses:
        '200':
          description: JWKS retornado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JWKS'
              example:
                keys:
                  - kty: RSA
                    use: sig
                    kid: auth-service-key-1
                    alg: RS256
                    n: xGOr-H7A...
                    e: AQAB

  # ===== SETUP =====
  /api/v1/setup/super-admin:
    post:
      tags:
        - Setup
      summary: Crear primer super administrador
      description: |
        Endpoint de configuraci√≥n inicial para crear el primer super administrador
        del sistema. Este endpoint solo puede ser utilizado una vez.

        **Caracter√≠sticas de seguridad:**
        - Solo funciona si no existe ning√∫n super admin
        - Retorna 403 si ya existe un super admin
        - No requiere autenticaci√≥n (endpoint p√∫blico de setup)
        - Una vez creado el super admin, este endpoint se bloquea

        **El super admin puede:**
        - Crear nuevas aplicaciones (multi-tenancy)
        - Gestionar configuraci√≥n global del sistema
        - Acceder a todos los endpoints sin restricciones

        **IMPORTANTE:** Este endpoint debe ser llamado inmediatamente despu√©s
        del deployment inicial y luego debe ser protegido/deshabilitado en producci√≥n.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - first_name
                - last_name
              properties:
                email:
                  type: string
                  format: email
                  example: superadmin@cloudcentinel.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: SuperSecure123!
                first_name:
                  type: string
                  minLength: 2
                  example: Super
                last_name:
                  type: string
                  minLength: 2
                  example: Admin
      responses:
        '201':
          description: Super admin creado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Super admin created successfully
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      email:
                        type: string
                        format: email
                      first_name:
                        type: string
                      last_name:
                        type: string
                      role:
                        type: string
                        example: super_admin
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          description: Super admin ya existe
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Super admin already exists. This endpoint can only be used once.

  # ===== AUTHENTICATION =====
  /api/v1/auth/register:
    post:
      tags:
        - Authentication
      summary: Registrar nuevo usuario
      description: |
        Crea un nuevo usuario en el sistema. El rol "user" se asigna autom√°ticamente.
        La contrase√±a debe cumplir con los requisitos de seguridad.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Usuario registrado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  message:
                    type: string
                    example: User registered successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: El email ya est√° registrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/login:
    post:
      tags:
        - Authentication
      summary: Iniciar sesi√≥n
      description: |
        Autentica un usuario y devuelve tokens JWT.
        - Access Token: 15 minutos de validez
        - Refresh Token: 7 d√≠as de validez

        El sistema bloquea la cuenta despu√©s de 5 intentos fallidos.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login exitoso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Credenciales inv√°lidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '423':
          description: Cuenta bloqueada por intentos fallidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/refresh:
    post:
      tags:
        - Authentication
      summary: Renovar tokens
      description: |
        Obtiene un nuevo par de tokens usando el refresh token.
        Implementa rotaci√≥n de tokens (el refresh token anterior se invalida).
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  description: Refresh token obtenido en login
                  example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Tokens renovados exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/auth/logout:
    post:
      tags:
        - Authentication
      summary: Cerrar sesi√≥n
      description: |
        Invalida la sesi√≥n actual eliminando el refresh token.
        El access token seguir√° v√°lido hasta su expiraci√≥n (m√°x 15 min).
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Sesi√≥n cerrada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/auth/forgot-password:
    post:
      tags:
        - Authentication
      summary: Solicitar reset de contrase√±a
      description: |
        Env√≠a un email con un link para resetear la contrase√±a.
        El token de reset expira en 1 hora.
        
        **Seguridad:** Siempre retorna 200 OK aunque el email no exista,
        para no revelar qu√© emails est√°n registrados.ados.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        '200':
          description: Email enviado (si el usuario existe)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: If the email exists, a password reset link has been sent
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/auth/reset-password:
    post:
      tags:
        - Authentication
      summary: Resetear contrase√±a con token
      description: |
        Resetea la contrase√±a usando el token recibido por email.
        
        **Efectos de seguridad:**
        - El token se invalida despu√©s de usarse (un solo uso)
        - Todas las sesiones activas se cierran
        - Todos los access tokens se invalidan (blacklist por timestamp)
        - Solo tokens emitidos DESPU√âS del reset ser√°n v√°lidos
        - Se env√≠a email de confirmaci√≥n
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - new_password
              properties:
                token:
                  type: string
                  description: Token recibido en el email de reset
                  example: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6
                new_password:
                  type: string
                  format: password
                  minLength: 8
                  description: Nueva contrase√±a (debe cumplir requisitos de seguridad)
                  example: NewSecurePass123!
      responses:
        '200':
          description: Contrase√±a reseteada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password reset successfully
        '400':
          description: Token inv√°lido o expirado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_token:
                  value:
                    error: true
                    message: Invalid or expired reset token
                    code: INVALID_RESET_TOKEN
                expired_token:
                  value:
                    error: true
                    message: Reset token has expired
                    code: EXPIRED_RESET_TOKEN

  # ===== USERS =====
  /api/v1/users/me:
    get:
      tags:
        - Users
      summary: Obtener perfil del usuario actual
      description: Retorna la informaci√≥n del usuario autenticado
      responses:
        '200':
          description: Perfil del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/auth/verify-email/{token}:
    get:
      tags:
        - Authentication
      summary: Verificar email
      description: |
        Verifica el email del usuario usando el token enviado al registrarse.
        El token expira en 24 horas.
      security: []
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
          description: Token de verificaci√≥n recibido por email
          example: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6
      responses:
        '200':
          description: Email verificado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Email verified successfully
        '400':
          description: Token inv√°lido o expirado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/resend-verification:
    post:
      tags:
        - Authentication
      summary: Reenviar email de verificaci√≥n
      description: |
        Genera un nuevo token de verificaci√≥n y lo env√≠a por email.
        Solo funciona si el email a√∫n no ha sido verificado.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        '200':
          description: Email de verificaci√≥n reenviado
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Verification email sent
        '400':
          description: Email ya verificado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/users/me/password:
    put:
      tags:
        - Users
      summary: Cambiar contrase√±a
      description: |
        Cambia la contrase√±a del usuario autenticado.
        Requiere la contrase√±a actual para validaci√≥n adicional.
        
        **Efectos de seguridad:**
        - Todas las sesiones activas se cierran
        - Todos los access tokens se invalidan (blacklist por timestamp)
        - Solo tokens emitidos DESPU√âS del cambio ser√°n v√°lidos
        - El usuario debe hacer login nuevamente
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - old_password
                - new_password
              properties:
                old_password:
                  type: string
                  format: password
                  example: OldPass123!
                new_password:
                  type: string
                  format: password
                  minLength: 8
                  example: NewPass123!
      responses:
        '200':
          description: Contrase√±a cambiada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: password changed successfully, all sessions have been invalidated
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Contrase√±a actual incorrecta
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: true
                message: Invalid old password
                code: INVALID_CREDENTIALS

  /api/v1/users/me/roles:
    get:
      tags:
        - Users
        - Roles
      summary: Obtener mis roles
      description: Lista todos los roles asignados al usuario actual
      responses:
        '200':
          description: Lista de roles del usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'
                  count:
                    type: integer
                    example: 2
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/users/me/permissions:
    get:
      tags:
        - Users
        - Permissions
      summary: Obtener mis permisos
      description: |
        Lista todos los permisos del usuario actual.
        Los permisos se calculan agregando todos los permisos de todos sus roles.
      responses:
        '200':
          description: Lista de permisos del usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  permissions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Permission'
                  count:
                    type: integer
                    example: 14
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/users/me/sessions:
    get:
      tags:
        - Users
      summary: Listar sesiones activas
      description: |
        Retorna todas las sesiones activas del usuario actual.

        **Informaci√≥n incluida:**
        - ID de la sesi√≥n
        - User-Agent (navegador/dispositivo)
        - Direcci√≥n IP
        - Fecha de creaci√≥n y expiraci√≥n
        - Indicador de sesi√≥n actual

        **Casos de uso:**
        - Ver d√≥nde est√° logueado el usuario
        - Detectar sesiones sospechosas
        - Auditar accesos
      responses:
        '200':
          description: Lista de sesiones activas
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Session'
                  count:
                    type: integer
                    example: 3
              example:
                sessions:
                  - id: 123e4567-e89b-12d3-a456-426614174000
                    user_agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
                    ip_address: 192.168.1.100
                    expires_at: 2025-01-22T10:00:00Z
                    created_at: 2025-01-15T10:00:00Z
                    is_current: true
                  - id: 456e7890-e89b-12d3-a456-426614174001
                    user_agent: Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)
                    ip_address: 192.168.1.105
                    expires_at: 2025-01-20T08:30:00Z
                    created_at: 2025-01-13T08:30:00Z
                    is_current: false
                count: 2
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      tags:
        - Users
      summary: Cerrar todas las sesiones
      description: |
        Cierra todas las sesiones activas del usuario.

        **Par√°metros opcionales:**
        - `exclude_current=true`: Mantiene la sesi√≥n actual activa y cierra solo las dem√°s
        - `exclude_current=false` (default): Cierra TODAS las sesiones incluyendo la actual

        **Limitaciones:**
        - Si `exclude_current=true` y no se puede identificar la sesi√≥n actual, se retorna error 400
        - La identificaci√≥n de la sesi√≥n actual requiere que el `session_id` est√© disponible en el contexto de la request

        **Efectos:**
        - Elimina todas las sesiones de la base de datos
        - Invalida todos los refresh tokens
        - El usuario debe hacer login nuevamente (si se incluye sesi√≥n actual)

        **Uso recomendado:**
        - Despu√©s de cambiar contrase√±a
        - Al detectar actividad sospechosa
        - Para cerrar sesi√≥n en todos los dispositivos
      parameters:
        - name: exclude_current
          in: query
          schema:
            type: boolean
            default: false
          description: Si es true, mantiene la sesi√≥n actual activa
          example: true
      responses:
        '200':
          description: Sesiones cerradas exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: All sessions closed successfully
                  deleted:
                    type: integer
                    description: N√∫mero de sesiones cerradas (solo si exclude_current=true)
                    example: 2
        '400':
          description: No se puede identificar la sesi√≥n actual para excluirla
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Cannot identify current session. Cannot exclude current session when session_id is not available in the request context.
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/users/me/sessions/{id}:
    delete:
      tags:
        - Users
      summary: Cerrar sesi√≥n espec√≠fica
      description: |
        Cierra una sesi√≥n espec√≠fica por su ID.

        **Seguridad:**
        - Solo puede cerrar sus propias sesiones
        - Retorna 403 si intenta cerrar sesi√≥n de otro usuario
        - Retorna 404 si la sesi√≥n no existe

        **Efecto:**
        - Elimina la sesi√≥n de la base de datos
        - Invalida el refresh token asociado
        - El dispositivo/navegador debe hacer login nuevamente

        **Caso de uso:**
        - Cerrar sesi√≥n sospechosa en dispositivo espec√≠fico
        - Logout remoto (ej: "cerrar sesi√≥n en iPhone")
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID de la sesi√≥n a cerrar
          example: 123e4567-e89b-12d3-a456-426614174000
      responses:
        '200':
          description: Sesi√≥n cerrada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Session closed successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: No autorizado para cerrar esta sesi√≥n
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: You can only delete your own sessions
        '404':
          description: Sesi√≥n no encontrada
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Session not found

  # ===== ADMIN - ROLES =====
  /api/v1/admin/roles:
    get:
      tags:
        - Roles
      summary: Listar roles
      description: |
        Obtiene todos los roles de una aplicaci√≥n espec√≠fica.
        **Requiere rol:** admin
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
          description: UUID de la aplicaci√≥n
          example: 7057e69d-818b-45db-b39b-9d1c84aca142
      responses:
        '200':
          description: Lista de roles
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'
                  count:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      tags:
        - Roles
      summary: Crear rol
      description: |
        Crea un nuevo rol en el sistema.
        **Requiere rol:** admin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRoleRequest'
      responses:
        '201':
          description: Rol creado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: Ya existe un rol con ese nombre en la aplicaci√≥n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/admin/roles/{id}:
    get:
      tags:
        - Roles
      summary: Obtener rol por ID
      description: |
        Obtiene los detalles de un rol espec√≠fico.
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/RoleId'
      responses:
        '200':
          description: Detalles del rol
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Roles
      summary: Actualizar rol
      description: |
        Actualiza la descripci√≥n de un rol existente.
        No se puede cambiar el nombre del rol.
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/RoleId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                description:
                  type: string
                  example: Editor con permisos ampliados
      responses:
        '200':
          description: Rol actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Roles
      summary: Eliminar rol
      description: |
        Elimina un rol del sistema.
        No se puede eliminar un rol que tenga usuarios asignados.
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/RoleId'
      responses:
        '200':
          description: Rol eliminado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Role deleted successfully
        '400':
          description: No se puede eliminar un rol con usuarios asignados
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/admin/roles/{id}/permissions:
    get:
      tags:
        - Roles
        - Permissions
      summary: Obtener permisos de un rol
      description: |
        Lista todos los permisos asignados a un rol espec√≠fico.
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/RoleId'
      responses:
        '200':
          description: Lista de permisos del rol
          content:
            application/json:
              schema:
                type: object
                properties:
                  permissions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Permission'
                  count:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ===== ADMIN - USER ROLES =====
  /api/v1/admin/users/{userId}/roles:
    get:
      tags:
        - Roles
        - Users
      summary: Obtener roles de un usuario
      description: |
        Lista todos los roles asignados a un usuario espec√≠fico.
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: Lista de roles del usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'
                  count:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/admin/users/{userId}/roles/{roleId}:
    post:
      tags:
        - Roles
        - Users
      summary: Asignar rol a usuario
      description: |
        Asigna un rol existente a un usuario.
        Si el usuario ya tiene el rol, no hace nada (idempotente).
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/UserId'
        - $ref: '#/components/parameters/RoleId'
      responses:
        '200':
          description: Rol asignado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Role assigned successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Roles
        - Users
      summary: Remover rol de usuario
      description: |
        Elimina un rol de un usuario.
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/UserId'
        - $ref: '#/components/parameters/RoleId'
      responses:
        '200':
          description: Rol removido exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Role removed successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ===== ADMIN - USER MANAGEMENT =====
  /api/v1/admin/users:
    get:
      tags:
        - Users
      summary: Listar usuarios
      description: |
        Lista todos los usuarios del sistema con paginaci√≥n y b√∫squeda.
        Incluye los roles asignados a cada usuario.
        **Requiere rol:** admin
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: N√∫mero de p√°gina
          example: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Cantidad de usuarios por p√°gina
          example: 20
        - name: search
          in: query
          schema:
            type: string
          description: Buscar por email, nombre o apellido
          example: john
      responses:
        '200':
          description: Lista de usuarios
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserWithRoles'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                        example: 1
                      limit:
                        type: integer
                        example: 20
                      total:
                        type: integer
                        example: 150
                      total_pages:
                        type: integer
                        example: 8
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/admin/users/{id}:
    get:
      tags:
        - Users
      summary: Obtener usuario por ID
      description: |
        Obtiene los detalles de un usuario espec√≠fico.
        Incluye los roles asignados al usuario.
        **Requiere rol:** admin
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID del usuario
          example: 123e4567-e89b-12d3-a456-426614174000
      responses:
        '200':
          description: Detalles del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserWithRoles'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ===== MODERATOR =====
  /api/v1/moderator/users/{userId}/roles:
    get:
      tags:
        - Roles
        - Users
      summary: Ver roles de usuario (Moderador)
      description: |
        Lista los roles de un usuario espec√≠fico.
        **Requiere rol:** admin o moderator
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: Lista de roles del usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'
                  count:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ===== SUPER ADMIN - APP MANAGEMENT =====
  /api/v1/super-admin/apps:
    post:
      tags:
        - Apps
      summary: Crear nueva aplicaci√≥n
      description: |
        Crea una nueva aplicaci√≥n en el sistema multi-tenant.
        **Requiere rol:** super_admin

        Cada aplicaci√≥n tiene:
        - ID √∫nico (UUID)
        - Client ID (generado autom√°ticamente para OAuth/API access)
        - Nombre y descripci√≥n
        - Roles y permisos independientes

        **Multi-tenancy:**
        - Cada app tiene sus propios roles
        - Los usuarios pueden tener diferentes roles en diferentes apps
        - Aislamiento completo entre aplicaciones
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  minLength: 2
                  maxLength: 100
                  example: Mi Aplicaci√≥n Web
                description:
                  type: string
                  maxLength: 500
                  example: Aplicaci√≥n web principal para gesti√≥n de usuarios
      responses:
        '201':
          description: Aplicaci√≥n creada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: App created successfully
                  app:
                    $ref: '#/components/schemas/App'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    get:
      tags:
        - Apps
      summary: Listar todas las aplicaciones
      description: |
        Retorna la lista completa de aplicaciones registradas en el sistema.
        **Requiere rol:** super_admin
      responses:
        '200':
          description: Lista de aplicaciones
          content:
            application/json:
              schema:
                type: object
                properties:
                  apps:
                    type: array
                    items:
                      $ref: '#/components/schemas/App'
                  count:
                    type: integer
                    example: 5
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/super-admin/apps/{id}:
    get:
      tags:
        - Apps
      summary: Obtener aplicaci√≥n espec√≠fica
      description: |
        Obtiene los detalles de una aplicaci√≥n por su ID.
        **Requiere rol:** super_admin
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID de la aplicaci√≥n
          example: 7057e69d-818b-45db-b39b-9d1c84aca142
      responses:
        '200':
          description: Detalles de la aplicaci√≥n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/App'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Aplicaci√≥n no encontrada
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: App not found

  # ===== ADMIN - TENANT MANAGEMENT =====
  /api/v1/admin/tenants:
    post:
      tags:
        - Tenants
      summary: Crear nuevo tenant
      description: |
        Crea un nuevo tenant (workspace/organizaci√≥n) dentro de una aplicaci√≥n.
        **Requiere rol:** admin

        **Tipos de tenant:**
        - `public`: Tenant p√∫blico por defecto (creado autom√°ticamente)
        - `workspace`: Workspace privado para equipos/organizaciones
        - `enterprise`: Tenant empresarial con cuotas personalizadas

        **Caracter√≠sticas:**
        - Aislamiento completo de usuarios por tenant
        - Control de cuotas (m√°ximo de usuarios)
        - Invitaciones por token para unirse al tenant
        - Slug √∫nico para URLs amigables
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - app_id
                - name
              properties:
                app_id:
                  type: string
                  format: uuid
                  description: UUID de la aplicaci√≥n
                  example: 7057e69d-818b-45db-b39b-9d1c84aca142
                name:
                  type: string
                  minLength: 2
                  maxLength: 255
                  description: Nombre del tenant
                  example: Acme Corporation
                slug:
                  type: string
                  minLength: 3
                  maxLength: 100
                  pattern: '^[a-z0-9-]+$'
                  description: Slug √∫nico (auto-generado si no se proporciona)
                  example: acme-corp
                type:
                  type: string
                  enum: [public, workspace, enterprise]
                  default: workspace
                  description: Tipo de tenant
                  example: workspace
                max_users:
                  type: integer
                  minimum: 1
                  description: M√°ximo de usuarios permitidos (null = ilimitado)
                  example: 50
                owner_id:
                  type: string
                  format: uuid
                  description: UUID del usuario propietario
                  example: 123e4567-e89b-12d3-a456-426614174000
      responses:
        '201':
          description: Tenant creado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Tenant created successfully
                  tenant:
                    $ref: '#/components/schemas/Tenant'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    get:
      tags:
        - Tenants
      summary: Listar tenants
      description: |
        Lista todos los tenants de una aplicaci√≥n con paginaci√≥n.
        **Requiere rol:** admin
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
          description: UUID de la aplicaci√≥n
          example: 7057e69d-818b-45db-b39b-9d1c84aca142
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: N√∫mero de p√°gina
          example: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Tenants por p√°gina
          example: 20
      responses:
        '200':
          description: Lista de tenants
          content:
            application/json:
              schema:
                type: object
                properties:
                  tenants:
                    type: array
                    items:
                      $ref: '#/components/schemas/Tenant'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                      limit:
                        type: integer
                      total:
                        type: integer
                      total_pages:
                        type: integer
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/admin/tenants/{id}:
    get:
      tags:
        - Tenants
      summary: Obtener tenant espec√≠fico
      description: |
        Obtiene los detalles de un tenant por su ID.
        **Requiere rol:** admin
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID del tenant
          example: 00000000-0000-0000-0000-000000000001
      responses:
        '200':
          description: Detalles del tenant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Tenants
      summary: Actualizar tenant
      description: |
        Actualiza la informaci√≥n de un tenant existente.
        **Requiere rol:** admin
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID del tenant
          example: 00000000-0000-0000-0000-000000000001
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 2
                  maxLength: 255
                  example: Acme Corporation Updated
                slug:
                  type: string
                  minLength: 3
                  maxLength: 100
                  pattern: '^[a-z0-9-]+$'
                  example: acme-corp-v2
                max_users:
                  type: integer
                  minimum: 1
                  example: 100
                status:
                  type: string
                  enum: [active, suspended, trial]
                  example: active
      responses:
        '200':
          description: Tenant actualizado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Tenant updated successfully
                  tenant:
                    $ref: '#/components/schemas/Tenant'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/admin/tenants/{id}/invitations:
    post:
      tags:
        - Tenants
      summary: Crear invitaci√≥n para tenant
      description: |
        Crea una invitaci√≥n con token √∫nico para que usuarios se unan al tenant.
        **Requiere rol:** admin o ser owner del tenant

        **Caracter√≠sticas del token:**
        - Generado aleatoriamente (256 bits)
        - Hasheado con SHA-256 en la base de datos
        - Solo se muestra una vez en la respuesta
        - Configurable: usos m√°ximos y expiraci√≥n
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID del tenant
          example: 00000000-0000-0000-0000-000000000001
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - expires_in_hours
              properties:
                role_id:
                  type: string
                  format: uuid
                  description: Rol a asignar autom√°ticamente al usuario que acepta
                  example: 20000000-0000-0000-0000-000000000001
                max_uses:
                  type: integer
                  minimum: 1
                  description: M√°ximo de usos permitidos (null = ilimitado)
                  example: 10
                expires_in_hours:
                  type: integer
                  minimum: 1
                  maximum: 720
                  description: Horas hasta expiraci√≥n (m√°x 30 d√≠as)
                  example: 168
      responses:
        '201':
          description: Invitaci√≥n creada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Invitation created successfully
                  invitation:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      tenant_id:
                        type: string
                        format: uuid
                      max_uses:
                        type: integer
                      current_uses:
                        type: integer
                      expires_at:
                        type: string
                        format: date-time
                      created_at:
                        type: string
                        format: date-time
                  token:
                    type: string
                    description: Token de invitaci√≥n (solo se muestra una vez)
                    example: dGhpc19pc19hX3NhbXBsZV90b2tlbl9mb3JfZGVtb25zdHJhdGlvbg==
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    get:
      tags:
        - Tenants
      summary: Listar invitaciones del tenant
      description: |
        Lista todas las invitaciones creadas para el tenant.
        **Requiere rol:** admin o ser owner del tenant
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID del tenant
          example: 00000000-0000-0000-0000-000000000001
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          example: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
      responses:
        '200':
          description: Lista de invitaciones
          content:
            application/json:
              schema:
                type: object
                properties:
                  invitations:
                    type: array
                    items:
                      $ref: '#/components/schemas/TenantInvitation'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                      limit:
                        type: integer
                      total:
                        type: integer
                      total_pages:
                        type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/admin/tenants/{id}/invitations/{invitationId}:
    delete:
      tags:
        - Tenants
      summary: Revocar invitaci√≥n
      description: |
        Revoca una invitaci√≥n activa.
        **Requiere rol:** admin o ser owner del tenant

        **Efecto:** La invitaci√≥n cambia a estado "revoked" y no puede usarse.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID del tenant
          example: 00000000-0000-0000-0000-000000000001
        - name: invitationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID de la invitaci√≥n
          example: 123e4567-e89b-12d3-a456-426614174000
      responses:
        '200':
          description: Invitaci√≥n revocada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Invitation revoked successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/auth/validate-invitation/{token}:
    get:
      tags:
        - Authentication
        - Tenants
      summary: Validar token de invitaci√≥n
      description: |
        Valida un token de invitaci√≥n antes de usarlo.
        **Endpoint p√∫blico** - No requiere autenticaci√≥n.

        **Validaciones:**
        - Token existe y es v√°lido
        - No ha expirado
        - No ha alcanzado el m√°ximo de usos
        - El tenant est√° activo
      security: []
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
          description: Token de invitaci√≥n recibido
          example: dGhpc19pc19hX3NhbXBsZV90b2tlbl9mb3JfZGVtb25zdHJhdGlvbg==
      responses:
        '200':
          description: Invitaci√≥n v√°lida
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: true
                  tenant:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      name:
                        type: string
                        example: Acme Corporation
                      slug:
                        type: string
                        example: acme-corp
                      type:
                        type: string
                        example: workspace
                  invitation:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      expires_at:
                        type: string
                        format: date-time
        '400':
          description: Token inv√°lido o expirado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Invalid or expired invitation token

# ===== COMPONENTS =====
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token obtenido del endpoint /api/v1/auth/login o /api/v1/auth/refresh.
        Formato: `Authorization: Bearer <token>`

  parameters:
    UserId:
      name: userId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: UUID del usuario
      example: 123e4567-e89b-12d3-a456-426614174000

    RoleId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: UUID del rol
      example: 20000000-0000-0000-0000-000000000001

  schemas:
    # ===== REQUEST SCHEMAS =====
    RegisterRequest:
      type: object
      required:
        - app_id
        - email
        - password
        - first_name
        - last_name
      properties:
        app_id:
          type: string
          format: uuid
          description: UUID de la aplicaci√≥n donde se registra el usuario
          example: 7057e69d-818b-45db-b39b-9d1c84aca142
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 8
          description: |
            Debe contener al menos:
            - 8 caracteres
            - 1 may√∫scula
            - 1 min√∫scula
            - 1 n√∫mero
            - 1 car√°cter especial
          example: SecurePass123!
        first_name:
          type: string
          minLength: 1
          maxLength: 100
          example: Juan
        last_name:
          type: string
          minLength: 1
          maxLength: 100
          example: P√©rez
        phone_number:
          anyOf:
            - type: string
            - type: "null"
          example: "+56912345678"

    LoginRequest:
      type: object
      required:
        - email
        - password
        - app_id
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          format: password
          example: SecurePass123!
        app_id:
          type: string
          format: uuid
          description: UUID de la aplicaci√≥n que solicita el login
          example: 7057e69d-818b-45db-b39b-9d1c84aca142

    CreateRoleRequest:
      type: object
      required:
        - app_id
        - name
        - description
      properties:
        app_id:
          type: string
          format: uuid
          example: 7057e69d-818b-45db-b39b-9d1c84aca142
        name:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[a-z0-9_]+$'
          description: Nombre del rol (solo min√∫sculas, n√∫meros y gui√≥n bajo)
          example: content_editor
        description:
          type: string
          maxLength: 255
          example: Editor de contenido con permisos de publicaci√≥n

    # ===== RESPONSE SCHEMAS =====
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174000
        app_id:
          type: string
          format: uuid
          description: UUID de la aplicaci√≥n a la que pertenece el usuario
          example: 7057e69d-818b-45db-b39b-9d1c84aca142
        tenant_id:
          type: string
          format: uuid
          description: UUID del tenant al que pertenece el usuario
          example: 00000000-0000-0000-0000-000000000001
        email:
          type: string
          format: email
          example: user@example.com
        provider:
          anyOf:
            - type: string
            - type: "null"
          description: Proveedor de autenticaci√≥n (google, github, etc.) para social login
          example: null
        provider_id:
          anyOf:
            - type: string
            - type: "null"
          description: ID del usuario en el proveedor externo
          example: null
        is_super_admin:
          type: boolean
          description: Indica si el usuario es super administrador del sistema
          example: false
        first_name:
          type: string
          example: Juan
        last_name:
          type: string
          example: P√©rez
        phone_number:
          anyOf:
            - type: string
            - type: "null"
          example: "+56912345678"
        email_verified:
          type: boolean
          example: false
        phone_verified:
          type: boolean
          example: false
        status:
          type: string
          enum: [active, inactive, suspended, deleted]
          example: active
        failed_login_attempts:
          type: integer
          example: 0
        account_locked_until:
          anyOf:
            - type: string
              format: date-time
            - type: "null"
          example: null
        created_at:
          type: string
          format: date-time
          example: 2025-01-15T10:30:00Z
        updated_at:
          type: string
          format: date-time
          example: 2025-01-15T10:30:00Z

    UserWithRoles:
      allOf:
        - $ref: '#/components/schemas/User'
        - type: object
          properties:
            roles:
              type: array
              items:
                type: string
              description: Lista de roles asignados al usuario
              example: ["user", "admin"]

    Role:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 20000000-0000-0000-0000-000000000001
        app_id:
          type: string
          format: uuid
          example: 7057e69d-818b-45db-b39b-9d1c84aca142
        name:
          type: string
          example: user
        description:
          type: string
          example: Usuario est√°ndar con permisos b√°sicos
        created_at:
          type: string
          format: date-time
          example: 2025-01-15T10:00:00Z

    Permission:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 10000000-0000-0000-0000-000000000001
        app_id:
          type: string
          format: uuid
          example: 7057e69d-818b-45db-b39b-9d1c84aca142
        resource:
          type: string
          description: Recurso sobre el que se aplica el permiso
          example: users
        action:
          type: string
          description: Acci√≥n permitida sobre el recurso
          example: read:own
        description:
          type: string
          example: Ver y leer el propio perfil de usuario
        created_at:
          type: string
          format: date-time
          example: 2025-01-15T10:00:00Z

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          description: JWT token con 15 minutos de validez
          example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWUsImlhdCI6MTUxNjIzOTAyMn0.POstGetfAytaZS82wHcjoTyoqhMyxXiWdR7Nn7A29DNSl0EiXLdwJ6xC6AfgZWF1bOsS_TuYI3OWDEjXwaYtuKY
        refresh_token:
          type: string
          description: Token para renovar el access_token (7 d√≠as de validez)
          example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          description: Tiempo de expiraci√≥n del access_token en segundos
          example: 900
        user:
          $ref: '#/components/schemas/User'

    Error:
      type: object
      properties:
        error:
          type: boolean
          example: true
        message:
          type: string
          example: Invalid credentials
        code:
          type: string
          example: INVALID_CREDENTIALS
        details:
          anyOf:
            - type: object
              additionalProperties: true
            - type: "null"

    # ===== JWKS SCHEMAS =====
    JWKS:
      type: object
      description: JSON Web Key Set - Conjunto de claves p√∫blicas
      properties:
        keys:
          type: array
          description: Array de claves p√∫blicas en formato JWK
          items:
            $ref: '#/components/schemas/JWK'
      example:
        keys:
          - kty: RSA
            use: sig
            kid: auth-service-key-1
            alg: RS256
            n: xGOr-H7A3kSPJWrH...
            e: AQAB

    JWK:
      type: object
      description: JSON Web Key - Clave p√∫blica en formato est√°ndar
      properties:
        kty:
          type: string
          description: Key Type
          example: RSA
        use:
          type: string
          description: Public Key Use
          example: sig
        kid:
          type: string
          description: Key ID - Identificador √∫nico de la clave
          example: auth-service-key-1
        alg:
          type: string
          description: Algorithm
          example: RS256
        n:
          type: string
          description: Modulus (base64url encoded)
          example: xGOr-H7A3kSPJWrH...
        e:
          type: string
          description: Exponent (base64url encoded)
          example: AQAB

    # ===== APP SCHEMAS =====
    App:
      type: object
      description: Aplicaci√≥n en el sistema multi-tenant
      properties:
        id:
          type: string
          format: uuid
          description: ID √∫nico de la aplicaci√≥n
          example: 7057e69d-818b-45db-b39b-9d1c84aca142
        name:
          type: string
          description: Nombre de la aplicaci√≥n
          example: Mi Aplicaci√≥n Web
        client_id:
          type: string
          description: Client ID para OAuth/API access
          example: app_a1b2c3d4e5f6g7h8
        description:
          type: string
          description: Descripci√≥n de la aplicaci√≥n
          example: Aplicaci√≥n web principal para gesti√≥n de usuarios
        created_at:
          type: string
          format: date-time
          description: Fecha de creaci√≥n
          example: 2025-01-15T10:00:00Z
        updated_at:
          type: string
          format: date-time
          description: Fecha de √∫ltima actualizaci√≥n
          example: 2025-01-15T10:00:00Z

    # ===== SESSION SCHEMAS =====
    Session:
      type: object
      description: Sesi√≥n activa del usuario con informaci√≥n de contexto
      properties:
        id:
          type: string
          format: uuid
          description: ID √∫nico de la sesi√≥n
          example: 123e4567-e89b-12d3-a456-426614174000
        user_agent:
          anyOf:
            - type: string
            - type: "null"
          description: User-Agent del navegador o aplicaci√≥n
          example: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
        ip_address:
          anyOf:
            - type: string
            - type: "null"
          description: Direcci√≥n IP desde donde se inici√≥ la sesi√≥n
          example: 192.168.1.100
        expires_at:
          type: string
          format: date-time
          description: Fecha y hora de expiraci√≥n de la sesi√≥n
          example: 2025-01-22T10:00:00Z
        created_at:
          type: string
          format: date-time
          description: Fecha y hora de creaci√≥n de la sesi√≥n
          example: 2025-01-15T10:00:00Z
        is_current:
          type: boolean
          description: Indica si es la sesi√≥n actual del usuario
          example: true

    # ===== TENANT SCHEMAS =====
    Tenant:
      type: object
      description: Tenant (workspace/organizaci√≥n) dentro de una aplicaci√≥n
      properties:
        id:
          type: string
          format: uuid
          description: ID √∫nico del tenant
          example: 00000000-0000-0000-0000-000000000001
        app_id:
          type: string
          format: uuid
          description: UUID de la aplicaci√≥n a la que pertenece
          example: 7057e69d-818b-45db-b39b-9d1c84aca142
        name:
          type: string
          description: Nombre del tenant
          example: Acme Corporation
        slug:
          type: string
          pattern: '^[a-z0-9-]+$'
          description: Slug √∫nico para URLs
          example: acme-corp
        type:
          type: string
          enum: [public, workspace, enterprise]
          description: Tipo de tenant
          example: workspace
        owner_id:
          anyOf:
            - type: string
              format: uuid
            - type: "null"
          description: UUID del usuario propietario
          example: 123e4567-e89b-12d3-a456-426614174000
        max_users:
          anyOf:
            - type: integer
              minimum: 1
            - type: "null"
          description: M√°ximo de usuarios permitidos (null = ilimitado)
          example: 50
        current_users_count:
          type: integer
          description: N√∫mero actual de usuarios (auto-calculado)
          example: 12
        status:
          type: string
          enum: [active, suspended, trial]
          description: Estado del tenant
          example: active
        metadata:
          anyOf:
            - type: object
              additionalProperties: true
            - type: "null"
          description: Metadata adicional en formato JSON
          example: {"plan": "pro", "billing_email": "billing@acme.com"}
        created_at:
          type: string
          format: date-time
          description: Fecha de creaci√≥n
          example: 2025-01-15T10:00:00Z
        updated_at:
          type: string
          format: date-time
          description: Fecha de √∫ltima actualizaci√≥n
          example: 2025-01-15T10:00:00Z

    TenantInvitation:
      type: object
      description: Invitaci√≥n para unirse a un tenant
      properties:
        id:
          type: string
          format: uuid
          description: ID √∫nico de la invitaci√≥n
          example: 123e4567-e89b-12d3-a456-426614174000
        tenant_id:
          type: string
          format: uuid
          description: UUID del tenant
          example: 00000000-0000-0000-0000-000000000001
        created_by:
          type: string
          format: uuid
          description: UUID del usuario que cre√≥ la invitaci√≥n
          example: 123e4567-e89b-12d3-a456-426614174000
        role_id:
          anyOf:
            - type: string
              format: uuid
            - type: "null"
          description: Rol a asignar autom√°ticamente (null = rol default)
          example: 20000000-0000-0000-0000-000000000001
        max_uses:
          anyOf:
            - type: integer
              minimum: 1
            - type: "null"
          description: M√°ximo de usos permitidos (null = ilimitado)
          example: 10
        current_uses:
          type: integer
          description: N√∫mero actual de usos
          example: 3
        expires_at:
          type: string
          format: date-time
          description: Fecha y hora de expiraci√≥n
          example: 2025-01-22T10:00:00Z
        status:
          type: string
          enum: [active, expired, revoked]
          description: Estado de la invitaci√≥n
          example: active
        created_at:
          type: string
          format: date-time
          description: Fecha de creaci√≥n
          example: 2025-01-15T10:00:00Z
        updated_at:
          type: string
          format: date-time
          description: Fecha de √∫ltima actualizaci√≥n
          example: 2025-01-15T10:00:00Z

  # ===== RESPONSES =====
  responses:
    BadRequest:
      description: Request inv√°lido (validaci√≥n fallida)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: true
            message: Validation failed
            details:
              email: must be a valid email
              password: must be at least 8 characters

    Unauthorized:
      description: No autenticado (token inv√°lido o expirado)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: true
            message: Unauthorized
            code: INVALID_TOKEN

    Forbidden:
      description: No autorizado (permisos insuficientes)
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Forbidden: insufficient permissions"
              required_roles:
                type: array
                items:
                  type: string
                example:
                  - admin

    NotFound:
      description: Recurso no encontrado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: true
            message: Resource not found
            code: NOT_FOUND
