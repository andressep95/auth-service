openapi: 3.0.3
info:
  title: Auth Service API
  description: |
    Servicio de autenticaci√≥n y autorizaci√≥n con soporte para:
    - Registro y login de usuarios
    - Gesti√≥n de sesiones con JWT (RS256)
    - Sistema RBAC (Role-Based Access Control)
    - Control de acceso granular con permisos
    - Multi-tenancy mediante App ID
    - Token blacklist con invalidaci√≥n por timestamp
    - Reset de contrase√±a seguro con email
    
    ## Sistema de Token Blacklist
    
    El servicio implementa un sistema de blacklist de dos niveles:
    
    ### 1. Blacklist Individual de Tokens
    Tokens espec√≠ficos pueden ser agregados a la blacklist (ej: al hacer logout).
    
    ### 2. Blacklist de Usuario por Timestamp
    Al cambiar/resetear contrase√±a, se guarda un timestamp de invalidaci√≥n.
    Todos los tokens emitidos ANTES de ese timestamp son rechazados.
    Tokens emitidos DESPU√âS del timestamp son aceptados.
    
    **Ejemplo:**
    ```
    10:00 - Login ‚Üí Token A (IssuedAt: 10:00)
    10:30 - Reset password ‚Üí Invalidation timestamp: 10:30
    10:31 - Token A rechazado (10:00 < 10:30)
    10:32 - Nuevo login ‚Üí Token B (IssuedAt: 10:32)
    10:33 - Token B aceptado (10:32 >= 10:30)
    ```
    
    Esto permite:
    - ‚úÖ Invalidar todos los tokens antiguos
    - ‚úÖ Permitir nuevos logins inmediatamente
    - ‚úÖ Evitar bloqueos permanentes del usuario
  version: 1.1.0
  contact:
    name: API Support
    email: support@authservice.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  x-changelog:
    - version: 1.1.0
      date: 2024-11-30
      changes:
        - "‚úÖ Agregados endpoints de forgot-password y reset-password"
        - "‚úÖ Agregados endpoints de verificaci√≥n de email"
        - "‚úÖ Agregado endpoint de cambio de contrase√±a"
        - "üîß Corregido bug cr√≠tico en token blacklist"
        - "üîí Mejorada seguridad del reset de contrase√±a"
        - "üìù Documentaci√≥n completa del sistema de blacklist"
    - version: 1.0.0
      date: 2024-11-15
      changes:
        - "üéâ Release inicial"
        - "‚úÖ Sistema de autenticaci√≥n con JWT"
        - "‚úÖ Sistema RBAC completo"
        - "‚úÖ Gesti√≥n de sesiones"
        - "‚úÖ Account locking"
        - "‚úÖ Multi-tenancy con App ID"

servers:
  - url: http://localhost:8080
    description: Desarrollo local
  - url: https://api.production.com
    description: Producci√≥n

tags:
  - name: Health
    description: Endpoints de health check
  - name: Authentication
    description: Registro, login, refresh y logout
  - name: Users
    description: Gesti√≥n de perfil de usuario
  - name: Roles
    description: Gesti√≥n de roles (Admin)
  - name: Permissions
    description: Consulta de permisos

security:
  - BearerAuth: []

paths:
  # ===== HEALTH CHECKS =====
  /health:
    get:
      tags:
        - Health
      summary: Health check b√°sico
      description: Verifica que el servicio est√° corriendo
      security: []
      responses:
        '200':
          description: Servicio saludable
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time

  /ready:
    get:
      tags:
        - Health
      summary: Readiness check
      description: Verifica que el servicio est√° listo para recibir tr√°fico
      security: []
      responses:
        '200':
          description: Servicio listo
          content:
            application/json:
              schema:
                type: object
                properties:
                  ready:
                    type: boolean
                  database:
                    type: string
                    example: connected
                  redis:
                    type: string
                    example: connected

  # ===== AUTHENTICATION =====
  /api/v1/auth/register:
    post:
      tags:
        - Authentication
      summary: Registrar nuevo usuario
      description: |
        Crea un nuevo usuario en el sistema. El rol "user" se asigna autom√°ticamente.
        La contrase√±a debe cumplir con los requisitos de seguridad.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Usuario registrado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  message:
                    type: string
                    example: User registered successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: El email ya est√° registrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/login:
    post:
      tags:
        - Authentication
      summary: Iniciar sesi√≥n
      description: |
        Autentica un usuario y devuelve tokens JWT.
        - Access Token: 15 minutos de validez
        - Refresh Token: 7 d√≠as de validez

        El sistema bloquea la cuenta despu√©s de 5 intentos fallidos.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login exitoso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Credenciales inv√°lidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '423':
          description: Cuenta bloqueada por intentos fallidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/refresh:
    post:
      tags:
        - Authentication
      summary: Renovar tokens
      description: |
        Obtiene un nuevo par de tokens usando el refresh token.
        Implementa rotaci√≥n de tokens (el refresh token anterior se invalida).
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  description: Refresh token obtenido en login
                  example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Tokens renovados exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/auth/logout:
    post:
      tags:
        - Authentication
      summary: Cerrar sesi√≥n
      description: |
        Invalida la sesi√≥n actual eliminando el refresh token.
        El access token seguir√° v√°lido hasta su expiraci√≥n (m√°x 15 min).
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Sesi√≥n cerrada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/auth/forgot-password:
    post:
      tags:
        - Authentication
      summary: Solicitar reset de contrase√±a
      description: |
        Env√≠a un email con un link para resetear la contrase√±a.
        El token de reset expira en 1 hora.
        
        **Seguridad:** Siempre retorna 200 OK aunque el email no exista,
        para no revelar qu√© emails est√°n registrados.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        '200':
          description: Email enviado (si el usuario existe)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: If the email exists, a password reset link has been sent
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/auth/reset-password:
    post:
      tags:
        - Authentication
      summary: Resetear contrase√±a con token
      description: |
        Resetea la contrase√±a usando el token recibido por email.
        
        **Efectos de seguridad:**
        - El token se invalida despu√©s de usarse (un solo uso)
        - Todas las sesiones activas se cierran
        - Todos los access tokens se invalidan (blacklist por timestamp)
        - Solo tokens emitidos DESPU√âS del reset ser√°n v√°lidos
        - Se env√≠a email de confirmaci√≥n
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - new_password
              properties:
                token:
                  type: string
                  description: Token recibido en el email de reset
                  example: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6
                new_password:
                  type: string
                  format: password
                  minLength: 8
                  description: Nueva contrase√±a (debe cumplir requisitos de seguridad)
                  example: NewSecurePass123!
      responses:
        '200':
          description: Contrase√±a reseteada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password reset successfully
        '400':
          description: Token inv√°lido o expirado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_token:
                  value:
                    error: true
                    message: Invalid or expired reset token
                    code: INVALID_RESET_TOKEN
                expired_token:
                  value:
                    error: true
                    message: Reset token has expired
                    code: EXPIRED_RESET_TOKEN

  # ===== USERS =====
  /api/v1/users/me:
    get:
      tags:
        - Users
      summary: Obtener perfil del usuario actual
      description: Retorna la informaci√≥n del usuario autenticado
      responses:
        '200':
          description: Perfil del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/auth/verify-email/{token}:
    get:
      tags:
        - Authentication
      summary: Verificar email
      description: |
        Verifica el email del usuario usando el token enviado al registrarse.
        El token expira en 24 horas.
      security: []
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
          description: Token de verificaci√≥n recibido por email
          example: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6
      responses:
        '200':
          description: Email verificado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Email verified successfully
        '400':
          description: Token inv√°lido o expirado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/resend-verification:
    post:
      tags:
        - Authentication
      summary: Reenviar email de verificaci√≥n
      description: |
        Genera un nuevo token de verificaci√≥n y lo env√≠a por email.
        Solo funciona si el email a√∫n no ha sido verificado.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        '200':
          description: Email de verificaci√≥n reenviado
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Verification email sent
        '400':
          description: Email ya verificado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/users/me/password:
    put:
      tags:
        - Users
      summary: Cambiar contrase√±a
      description: |
        Cambia la contrase√±a del usuario autenticado.
        Requiere la contrase√±a actual para validaci√≥n adicional.
        
        **Efectos de seguridad:**
        - Todas las sesiones activas se cierran
        - Todos los access tokens se invalidan (blacklist por timestamp)
        - Solo tokens emitidos DESPU√âS del cambio ser√°n v√°lidos
        - El usuario debe hacer login nuevamente
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - old_password
                - new_password
              properties:
                old_password:
                  type: string
                  format: password
                  example: OldPass123!
                new_password:
                  type: string
                  format: password
                  minLength: 8
                  example: NewPass123!
      responses:
        '200':
          description: Contrase√±a cambiada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: password changed successfully, all sessions have been invalidated
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Contrase√±a actual incorrecta
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: true
                message: Invalid old password
                code: INVALID_CREDENTIALS

  /api/v1/users/me/roles:
    get:
      tags:
        - Users
        - Roles
      summary: Obtener mis roles
      description: Lista todos los roles asignados al usuario actual
      responses:
        '200':
          description: Lista de roles del usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'
                  count:
                    type: integer
                    example: 2
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/users/me/permissions:
    get:
      tags:
        - Users
        - Permissions
      summary: Obtener mis permisos
      description: |
        Lista todos los permisos del usuario actual.
        Los permisos se calculan agregando todos los permisos de todos sus roles.
      responses:
        '200':
          description: Lista de permisos del usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  permissions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Permission'
                  count:
                    type: integer
                    example: 14
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ===== ADMIN - ROLES =====
  /api/v1/admin/roles:
    get:
      tags:
        - Roles
      summary: Listar roles
      description: |
        Obtiene todos los roles de una aplicaci√≥n espec√≠fica.
        **Requiere rol:** admin
      parameters:
        - name: app_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
          description: UUID de la aplicaci√≥n
          example: 00000000-0000-0000-0000-000000000000
      responses:
        '200':
          description: Lista de roles
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'
                  count:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      tags:
        - Roles
      summary: Crear rol
      description: |
        Crea un nuevo rol en el sistema.
        **Requiere rol:** admin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRoleRequest'
      responses:
        '201':
          description: Rol creado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: Ya existe un rol con ese nombre en la aplicaci√≥n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/admin/roles/{id}:
    get:
      tags:
        - Roles
      summary: Obtener rol por ID
      description: |
        Obtiene los detalles de un rol espec√≠fico.
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/RoleId'
      responses:
        '200':
          description: Detalles del rol
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Roles
      summary: Actualizar rol
      description: |
        Actualiza la descripci√≥n de un rol existente.
        No se puede cambiar el nombre del rol.
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/RoleId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                description:
                  type: string
                  example: Editor con permisos ampliados
      responses:
        '200':
          description: Rol actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Roles
      summary: Eliminar rol
      description: |
        Elimina un rol del sistema.
        No se puede eliminar un rol que tenga usuarios asignados.
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/RoleId'
      responses:
        '200':
          description: Rol eliminado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Role deleted successfully
        '400':
          description: No se puede eliminar un rol con usuarios asignados
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/admin/roles/{id}/permissions:
    get:
      tags:
        - Roles
        - Permissions
      summary: Obtener permisos de un rol
      description: |
        Lista todos los permisos asignados a un rol espec√≠fico.
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/RoleId'
      responses:
        '200':
          description: Lista de permisos del rol
          content:
            application/json:
              schema:
                type: object
                properties:
                  permissions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Permission'
                  count:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ===== ADMIN - USER ROLES =====
  /api/v1/admin/users/{userId}/roles:
    get:
      tags:
        - Roles
        - Users
      summary: Obtener roles de un usuario
      description: |
        Lista todos los roles asignados a un usuario espec√≠fico.
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: Lista de roles del usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'
                  count:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/admin/users/{userId}/roles/{roleId}:
    post:
      tags:
        - Roles
        - Users
      summary: Asignar rol a usuario
      description: |
        Asigna un rol existente a un usuario.
        Si el usuario ya tiene el rol, no hace nada (idempotente).
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/UserId'
        - $ref: '#/components/parameters/RoleId'
      responses:
        '200':
          description: Rol asignado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Role assigned successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Roles
        - Users
      summary: Remover rol de usuario
      description: |
        Elimina un rol de un usuario.
        **Requiere rol:** admin
      parameters:
        - $ref: '#/components/parameters/UserId'
        - $ref: '#/components/parameters/RoleId'
      responses:
        '200':
          description: Rol removido exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Role removed successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ===== MODERATOR =====
  /api/v1/moderator/users/{userId}/roles:
    get:
      tags:
        - Roles
        - Users
      summary: Ver roles de usuario (Moderador)
      description: |
        Lista los roles de un usuario espec√≠fico.
        **Requiere rol:** admin o moderator
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: Lista de roles del usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'
                  count:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

# ===== COMPONENTS =====
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token obtenido del endpoint /api/v1/auth/login o /api/v1/auth/refresh.
        Formato: `Authorization: Bearer <token>`

  parameters:
    UserId:
      name: userId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: UUID del usuario
      example: 123e4567-e89b-12d3-a456-426614174000

    RoleId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: UUID del rol
      example: 20000000-0000-0000-0000-000000000001

  schemas:
    # ===== REQUEST SCHEMAS =====
    RegisterRequest:
      type: object
      required:
        - email
        - password
        - first_name
        - last_name
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 8
          description: |
            Debe contener al menos:
            - 8 caracteres
            - 1 may√∫scula
            - 1 min√∫scula
            - 1 n√∫mero
            - 1 car√°cter especial
          example: SecurePass123!
        first_name:
          type: string
          minLength: 1
          maxLength: 100
          example: Juan
        last_name:
          type: string
          minLength: 1
          maxLength: 100
          example: P√©rez
        phone_number:
          type: string
          nullable: true
          example: "+56912345678"

    LoginRequest:
      type: object
      required:
        - email
        - password
        - app_id
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          format: password
          example: SecurePass123!
        app_id:
          type: string
          format: uuid
          description: UUID de la aplicaci√≥n que solicita el login
          example: 00000000-0000-0000-0000-000000000000

    CreateRoleRequest:
      type: object
      required:
        - app_id
        - name
        - description
      properties:
        app_id:
          type: string
          format: uuid
          example: 00000000-0000-0000-0000-000000000000
        name:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[a-z0-9_]+$'
          description: Nombre del rol (solo min√∫sculas, n√∫meros y gui√≥n bajo)
          example: content_editor
        description:
          type: string
          maxLength: 255
          example: Editor de contenido con permisos de publicaci√≥n

    # ===== RESPONSE SCHEMAS =====
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174000
        email:
          type: string
          format: email
          example: user@example.com
        first_name:
          type: string
          example: Juan
        last_name:
          type: string
          example: P√©rez
        phone_number:
          type: string
          nullable: true
          example: "+56912345678"
        email_verified:
          type: boolean
          example: false
        phone_verified:
          type: boolean
          example: false
        status:
          type: string
          enum: [active, inactive, suspended, deleted]
          example: active
        failed_login_attempts:
          type: integer
          example: 0
        account_locked_until:
          type: string
          format: date-time
          nullable: true
          example: null
        created_at:
          type: string
          format: date-time
          example: 2025-01-15T10:30:00Z
        updated_at:
          type: string
          format: date-time
          example: 2025-01-15T10:30:00Z

    Role:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 20000000-0000-0000-0000-000000000001
        app_id:
          type: string
          format: uuid
          example: 00000000-0000-0000-0000-000000000000
        name:
          type: string
          example: user
        description:
          type: string
          example: Usuario est√°ndar con permisos b√°sicos
        created_at:
          type: string
          format: date-time
          example: 2025-01-15T10:00:00Z

    Permission:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 10000000-0000-0000-0000-000000000001
        app_id:
          type: string
          format: uuid
          example: 00000000-0000-0000-0000-000000000000
        resource:
          type: string
          description: Recurso sobre el que se aplica el permiso
          example: users
        action:
          type: string
          description: Acci√≥n permitida sobre el recurso
          example: read:own
        description:
          type: string
          example: Ver y leer el propio perfil de usuario
        created_at:
          type: string
          format: date-time
          example: 2025-01-15T10:00:00Z

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          description: JWT token con 15 minutos de validez
          example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWUsImlhdCI6MTUxNjIzOTAyMn0.POstGetfAytaZS82wHcjoTyoqhMyxXiWdR7Nn7A29DNSl0EiXLdwJ6xC6AfgZWF1bOsS_TuYI3OWDEjXwaYtuKY
        refresh_token:
          type: string
          description: Token para renovar el access_token (7 d√≠as de validez)
          example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          description: Tiempo de expiraci√≥n del access_token en segundos
          example: 900
        user:
          $ref: '#/components/schemas/User'

    Error:
      type: object
      properties:
        error:
          type: boolean
          example: true
        message:
          type: string
          example: Invalid credentials
        code:
          type: string
          example: INVALID_CREDENTIALS
        details:
          type: object
          nullable: true
          additionalProperties: true

  # ===== RESPONSES =====
  responses:
    BadRequest:
      description: Request inv√°lido (validaci√≥n fallida)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: true
            message: Validation failed
            details:
              email: must be a valid email
              password: must be at least 8 characters

    Unauthorized:
      description: No autenticado (token inv√°lido o expirado)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: true
            message: Unauthorized
            code: INVALID_TOKEN

    Forbidden:
      description: No autorizado (permisos insuficientes)
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Forbidden: insufficient permissions"
              required_roles:
                type: array
                items:
                  type: string
                example:
                  - admin

    NotFound:
      description: Recurso no encontrado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: true
            message: Resource not found
            code: NOT_FOUND
