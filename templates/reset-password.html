{{define "reset-password-content"}}
<div class="reset-content">
    <div class="reset-icon-wrapper">
        <svg class="reset-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
        </svg>
    </div>
    <h2>Resetear contraseña</h2>
    <p>Ingresa tu nueva contraseña.</p>

    <div id="serverError" class="alert alert-error" style="display: none;"></div>

    <form id="resetForm" class="reset-form">
        <input type="hidden" name="token" value="{{.Token}}">

        <div class="field">
            <label for="new_password">Nueva contraseña</label>
            <div class="password-wrapper">
                <input
                    type="password"
                    id="new_password"
                    name="new_password"
                    placeholder="Nueva contraseña"
                    autocomplete="new-password"
                >
                <button type="button" class="password-toggle" onclick="togglePassword('new_password', this)">
                    <svg class="eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg class="eye-closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>
                </button>
            </div>
            <small class="p-error" id="passwordError" style="display: none;"></small>
        </div>

        <div class="field">
            <label for="confirm_password">Confirmar contraseña</label>
            <div class="password-wrapper">
                <input
                    type="password"
                    id="confirm_password"
                    name="confirm_password"
                    placeholder="Confirmar contraseña"
                    autocomplete="new-password"
                >
                <button type="button" class="password-toggle" onclick="togglePassword('confirm_password', this)">
                    <svg class="eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <svg class="eye-closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>
                </button>
            </div>
            <small class="p-error" id="confirmPasswordError" style="display: none;"></small>
        </div>

        <button type="submit" class="btn submit-button" id="submitBtn">
            <span id="btnText">Resetear contraseña</span>
            <div class="btn-spinner" id="btnSpinner" style="display: none;"></div>
        </button>
    </form>

    <div class="back-to-login">
        <a href="/auth/login">← Volver al login</a>
    </div>
</div>

<script>
    (function() {
        const form = document.getElementById('resetForm');
        const passwordInput = document.getElementById('new_password');
        const confirmPasswordInput = document.getElementById('confirm_password');
        const passwordError = document.getElementById('passwordError');
        const confirmPasswordError = document.getElementById('confirmPasswordError');
        const serverError = document.getElementById('serverError');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        const token = '{{.Token}}';

        let hasSubmitted = false;

        // Validación en tiempo real SOLO después del primer submit
        [passwordInput, confirmPasswordInput].forEach(input => {
            input.addEventListener('input', () => {
                if (!hasSubmitted) return;
                input.id === 'new_password' ? validatePassword() : validateConfirmPassword();
            });
        });

        function validatePassword() {
            const value = passwordInput.value;
            if (!value) {
                showError(passwordError, 'La contraseña es requerida');
                passwordInput.classList.add('p-invalid');
                return false;
            }
            if (value.length < 8) {
                showError(passwordError, 'La contraseña debe tener al menos 8 caracteres');
                passwordInput.classList.add('p-invalid');
                return false;
            }
            hideError(passwordError);
            passwordInput.classList.remove('p-invalid');
            return true;
        }

        function validateConfirmPassword() {
            const value = confirmPasswordInput.value;
            if (!value) {
                showError(confirmPasswordError, 'Confirma tu contraseña');
                confirmPasswordInput.classList.add('p-invalid');
                return false;
            }
            if (value !== passwordInput.value) {
                showError(confirmPasswordError, 'Las contraseñas no coinciden');
                confirmPasswordInput.classList.add('p-invalid');
                return false;
            }
            hideError(confirmPasswordError);
            confirmPasswordInput.classList.remove('p-invalid');
            return true;
        }

        function showError(element, message) {
            element.textContent = message;
            element.style.display = 'block';
        }

        function hideError(element) {
            element.style.display = 'none';
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            hasSubmitted = true;

            // Validar todos los campos
            const passwordValid = validatePassword();
            const confirmPasswordValid = validateConfirmPassword();

            if (!passwordValid || !confirmPasswordValid) {
                return;
            }

            if (!token) {
                serverError.textContent = 'Token de reset inválido';
                serverError.style.display = 'block';
                return;
            }

            // Mostrar loading
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline-block';
            serverError.style.display = 'none';

            try {
                const response = await fetch('/api/v1/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token,
                        new_password: passwordInput.value
                    }),
                });

                const result = await response.json();

                if (response.ok) {
                    // Reset exitoso
                    serverError.className = 'alert alert-success';
                    serverError.textContent = 'Contraseña reseteada correctamente. Redirigiendo al login...';
                    serverError.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = '/auth/login';
                    }, 2000);
                } else {
                    // Error de reset
                    const isExpiredToken = result.error?.includes('expired') || result.message?.includes('expired');
                    serverError.className = 'alert alert-error';
                    serverError.textContent = isExpiredToken
                        ? 'El enlace ha expirado. Solicita uno nuevo desde "Olvidé mi contraseña"'
                        : (result.error || result.message || 'Error al resetear la contraseña');
                    serverError.style.display = 'block';
                }
            } catch (error) {
                serverError.className = 'alert alert-error';
                serverError.textContent = 'Error de conexión. Por favor, intenta nuevamente.';
                serverError.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                btnSpinner.style.display = 'none';
            }
        });
    })();

    function togglePassword(id, btn) {
        const input = document.getElementById(id);
        const eyeOpen = btn.querySelector('.eye-open');
        const eyeClosed = btn.querySelector('.eye-closed');

        const isPassword = input.type === 'password';
        input.type = isPassword ? 'text' : 'password';

        eyeOpen.style.display = isPassword ? 'none' : 'block';
        eyeClosed.style.display = isPassword ? 'block' : 'none';
    }
    window.togglePassword = togglePassword;
</script>
{{end}}
