{{define "login-content"}}
<div id="serverError" class="alert alert-error" style="display: none;"></div>

<form id="loginForm" method="POST" action="/api/v1/auth/login">
    <!-- OAuth2 parameters (hidden fields) -->
    {{if .RedirectURI}}
    <input type="hidden" name="redirect_uri" value="{{.RedirectURI}}">
    {{end}}
    {{if .State}}
    <input type="hidden" name="state" value="{{.State}}">
    {{end}}
    {{if .ResponseType}}
    <input type="hidden" name="response_type" value="{{.ResponseType}}">
    {{end}}
    {{if .Scope}}
    <input type="hidden" name="scope" value="{{.Scope}}">
    {{end}}

    <div class="field">
        <label for="email">Email</label>
        <input
            type="email"
            id="email"
            name="email"
            placeholder="usuario@ejemplo.com"
            autocomplete="email"
            autofocus
        >
        <small class="p-error" id="emailError" style="display: none;"></small>
    </div>

    <div class="field">
        <label for="password">Contraseña</label>
        <div class="password-wrapper">
            <input
                type="password"
                id="password"
                name="password"
                placeholder="Ingresa tu contraseña"
                autocomplete="current-password"
            >
            <button
                type="button"
                class="password-toggle"
                onclick="togglePassword('password', this)"
            >
                <svg class="eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg class="eye-closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
            </button>
        </div>
        <small class="p-error" id="passwordError" style="display: none;"></small>
    </div>

    <button type="submit" class="btn submit-button" id="submitBtn">
        <span id="btnText">Iniciar Sesión</span>
        <div class="btn-spinner" id="btnSpinner" style="display: none;"></div>
    </button>

    <div class="forgot-password-link">
        <a href="/auth/forgot-password">¿Olvidaste tu contraseña?</a>
    </div>

    <div class="form-footer-link register-link">
        <span>¿No tienes cuenta? </span>
        <a href="/auth/register" class="link-button">Regístrate</a>
    </div>
</form>
<script>
    (function () {
        // -------------------------
        // State
        // -------------------------
        let hasSubmitted = false;
    
        // -------------------------
        // Elements
        // -------------------------
        const form = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
    
        const emailError = document.getElementById('emailError');
        const passwordError = document.getElementById('passwordError');
        const serverError = document.getElementById('serverError');
    
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
    
        // -------------------------
        // Helpers
        // -------------------------
        function showError(el, message) {
            el.textContent = message;
            el.style.display = 'block';
        }
    
        function hideError(el) {
            el.textContent = '';
            el.style.display = 'none';
        }
    
        function setInvalid(input, errorEl, message) {
            showError(errorEl, message);
            input.classList.add('p-invalid');
        }
    
        function setValid(input, errorEl) {
            hideError(errorEl);
            input.classList.remove('p-invalid');
        }
    
        // -------------------------
        // Validators
        // -------------------------
        function validateEmail() {
            const value = emailInput.value.trim();
            if (!value) {
                setInvalid(emailInput, emailError, 'El email es requerido');
                return false;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                setInvalid(emailInput, emailError, 'El email no es válido');
                return false;
            }
            setValid(emailInput, emailError);
            return true;
        }
    
        function validatePassword() {
            if (!passwordInput.value) {
                setInvalid(passwordInput, passwordError, 'La contraseña es requerida');
                return false;
            }
            setValid(passwordInput, passwordError);
            return true;
        }
    
        function validateForm() {
            return validateEmail() && validatePassword();
        }
    
        // -------------------------
        // Live validation (after submit)
        // -------------------------
        [emailInput, passwordInput].forEach(input => {
            input.addEventListener('input', () => {
                if (!hasSubmitted) return;
                input.id === 'email' ? validateEmail() : validatePassword();
            });
        });
    
        // -------------------------
        // Submit
        // -------------------------
        form.addEventListener('submit', async (e) => {
            hasSubmitted = true;

            if (!validateForm()) {
                e.preventDefault();
                return;
            }

            // Check if this is an OAuth2 flow
            const formData = new FormData(form);
            const isOAuth2 = formData.get('redirect_uri') && formData.get('response_type') === 'code';

            if (isOAuth2) {
                // OAuth2 flow: Let the form submit naturally (server will redirect)
                // Show loading state but don't prevent submit
                submitBtn.disabled = true;
                btnText.textContent = 'Autorizando...';
                btnText.style.display = 'inline';
                btnSpinner.style.display = 'inline-block';
                return; // Allow form to submit
            }

            // Standard API flow: Prevent default and handle with JavaScript
            e.preventDefault();

            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline-block';
            hideError(serverError);

            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    window.location.href = result.redirect_url || '/dashboard';
                } else {
                    showError(serverError, result.error || 'Error al iniciar sesión');
                }
            } catch {
                showError(serverError, 'Error de conexión. Intenta nuevamente.');
            } finally {
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                btnSpinner.style.display = 'none';
            }
        });
    })();
    
    // -------------------------
    // Password toggle (GLOBAL)
    // -------------------------
    window.togglePassword = function (inputId, button) {
        const input = document.getElementById(inputId);
        const eyeOpen = button.querySelector('.eye-open');
        const eyeClosed = button.querySelector('.eye-closed');
    
        if (!input || !eyeOpen || !eyeClosed) return;
    
        if (input.type === 'password') {
            input.type = 'text';
            eyeOpen.style.display = 'none';
            eyeClosed.style.display = 'block';
        } else {
            input.type = 'password';
            eyeOpen.style.display = 'block';
            eyeClosed.style.display = 'none';
        }
    };
</script>
{{end}}
