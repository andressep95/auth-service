{{define "register-content"}}

<div id="serverError" class="alert alert-error" style="display:none;"></div>

<!-- ===================== -->
<!-- Register Form -->
<!-- ===================== -->
<div id="registerFormWrapper">
<form id="registerForm" novalidate>

    <input type="hidden" name="app_id" value="{{.AppID}}">
    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

    <div class="field">
        <label for="first_name">Nombre</label>
        <input id="first_name" name="first_name" type="text"
               autocomplete="given-name" placeholder="Ingresa tu nombre">
        <small class="p-error" id="firstNameError" style="display: none;"></small>
    </div>

    <div class="field">
        <label for="last_name">Apellido</label>
        <input id="last_name" name="last_name" type="text"
               autocomplete="family-name" placeholder="Ingresa tu apellido">
        <small class="p-error" id="lastNameError" style="display: none;"></small>
    </div>

    <div class="field">
        <label for="email">Email</label>
        <input id="email" name="email" type="email"
               autocomplete="email" placeholder="usuario@ejemplo.com">
        <small class="p-error" id="emailError" style="display: none;"></small>
    </div>

    <div class="field">
        <label for="password">Contraseña</label>
        <div class="password-wrapper">
            <input id="password" name="password" type="password"
                   autocomplete="new-password" placeholder="Ingresa tu contraseña">
            <button type="button" class="password-toggle" onclick="togglePassword('password', this)">
                <svg class="eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg class="eye-closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
            </button>
        </div>
        <small class="p-error" id="passwordError" style="display: none;"></small>
    </div>

    <div class="field">
        <label for="password_confirm">Confirmar Contraseña</label>
        <div class="password-wrapper">
            <input id="password_confirm" type="password"
                   autocomplete="new-password" placeholder="Confirma tu contraseña">
            <button type="button" class="password-toggle" onclick="togglePassword('password_confirm', this)">
                <svg class="eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg class="eye-closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
            </button>
        </div>
        <small class="p-error" id="confirmPasswordError" style="display: none;"></small>
    </div>

    <button type="submit" class="btn submit-button" id="submitBtn">
        <span id="btnText">Registrarse</span>
        <div class="btn-spinner" id="btnSpinner" style="display:none;"></div>
    </button>

    <div class="form-footer-link login-link">
        <span>¿Ya tienes cuenta?</span>
        <a href="/auth/login?app_id={{.AppID}}">Inicia sesión</a>
    </div>

</form>
</div>

<!-- ===================== -->
<!-- Success View -->
<!-- ===================== -->
<div id="successView" class="success-view" style="display:none;">
    <div class="success-icon-wrapper">
        <svg class="success-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
    </div>
    
    <h2>¡Registro exitoso!</h2>
    <p>Hemos enviado un enlace de verificación a tu correo:</p>
    <strong id="successEmail" class="highlight-email"></strong>
    
    <p class="success-note">Revisa tu bandeja de entrada (y la carpeta de spam) para activar tu cuenta.</p>
    
    <button class="btn" onclick="goToLogin()">
        Ir al inicio de sesión
    </button>
</div>

<script>
(function () {

    const form = document.getElementById('registerForm');
    const serverError = document.getElementById('serverError');

    function togglePassword(id, btn) {
        const input = document.getElementById(id);
        const eyeOpen = btn.querySelector('.eye-open');
        const eyeClosed = btn.querySelector('.eye-closed');

        const isPassword = input.type === 'password';
        input.type = isPassword ? 'text' : 'password';

        eyeOpen.style.display = isPassword ? 'none' : 'block';
        eyeClosed.style.display = isPassword ? 'block' : 'none';
    }
    window.togglePassword = togglePassword;

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        serverError.style.display = 'none';

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        if (data.password !== document.getElementById('password_confirm').value) {
            serverError.textContent = 'Las contraseñas no coinciden';
            serverError.style.display = 'block';
            return;
        }

        const csrfToken = data.csrf_token;
        delete data.csrf_token;
        delete data.password_confirm;

        try {
            const res = await fetch('/api/v1/auth/register', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(data)
            });

            const json = await res.json();

            if (!res.ok) {
                serverError.textContent = json.error || 'Error de registro';
                serverError.style.display = 'block';
                return;
            }

            document.getElementById('registerFormWrapper').style.display = 'none';
            document.getElementById('successView').style.display = 'block';
            document.getElementById('successEmail').textContent = data.email;

        } catch {
            serverError.textContent = 'Error de conexión';
            serverError.style.display = 'block';
        }
    });
})();

function goToLogin() {
    window.location.href = "/auth/login?app_id={{.AppID}}";
}
</script>

{{end}}
